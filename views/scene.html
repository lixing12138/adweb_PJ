<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset=utf-8>
    <title>场景漫游——多人交互</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 100%
        }
        
        #chat {
            position: relative;
            display: none;
        }
        
        #description {
            position: absolute;
            right: 0;
            top: 30px;
            z-index: 11;
        }
        
        #close {
            display: none;
            position: absolute;
            right: 5px;
            top: 5px;
        }
        
        #close::before {
            content: "\2716";
        }
        
        #close:hover {
            background-color: rgba(124, 238, 205, 0.41);
        }
        
        #questions {
            /*display: none;*/
            width: 40%;
            min-width: 350px;
            height: 100%;
            z-index: 10;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.13);
            left: 30%;
            bottom: auto;
        }
        
        #question {
            position: absolute;
            width: 100%;
            height: 70%;
            min-height: 100px;
            top: 10%;
        }
        
        #question-title {
            position: absolute;
            left: 10%;
            top: 10%;
        }
        
        #detail {
            position: absolute;
            width: 100%;
            height: 40%;
            top: 20%;
        }
        
        #answer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            min-width: 350px;
            height: 20%;
        }
        
        #options {
            position: absolute;
            bottom: 30%;
            left: 10%;
        }
        
        #viewAnswer {
            position: absolute;
            bottom: 20%;
            left: 20%;
        }
        
        #viewNext {
            position: absolute;
            bottom: 20%;
            left: 70%;
        }
        
        #chatLog {
            min-width: 250px;
            max-width: 250px;
            min-height: 250px;
            max-height: 250px;
            background-color: rgba(186, 215, 193, 0.19);
            overflow: auto;
        }
        
        #scrollbar-y {
            margin: 0 auto;
        }
        
        #scrollbar-x {
            width: 30px;
            height: 30px;
            margin: auto 0;
        }
        
        #block {
            width: 260px;
            z-index: 10;
            position: absolute;
            left: 10px;
            bottom: 20px;
        }
        
        #chatLog::-webkit-scrollbar {
            /*滚动条整体样式*/
            width: 10px;
            /*高宽分别对应横竖滚动条的尺寸*/
            height: 10px;
        }
        
        #chatLog::-webkit-scrollbar-thumb {
            /*滚动条里面小方块*/
            border-radius: 10px;
            background: rgba(83, 83, 83, 0.6);
        }
        
        #chatLog::-webkit-scrollbar-track {
            /*滚动条里面轨道*/
            border-radius: 10px;
            background: #EDEDED;
        }
        
        #chatMany {
            min-width: 249px;
            min-height: 25px;
            background-color: rgba(186, 215, 193, 0.19);
        }
        
        #user {
            position: absolute;
            margin: 10px;
        }
        
        #userList {
            min-width: 249px;
        }
    </style>
</head>


<body>
    <div id="block">
        <div id="chatLog">
            <div class="scrollbar" id="scrollbar-y"></div>
            <div class="scrollbar" id="scrollbar-x"></div>
        </div>
        <div id="chat">
            <select id="userList">
                <option id = "all">all</option>
            </select>
            <input id="chatMany" autofocus=autofocus value="">
        </div>
    </div>
    <div id="description">
        <h3 id="title"></h3>
        <p id="content"></p>
    </div>
    <div id="user">
        <p>姓名：<span id="getUserName">{{ name }}</span></p>
        <p>性别：<span id="gender">{{ gender || '中'}}</span></p>
        <p>称号：
            <span id="getLevel">
                {{if (score > 300)}}6的不行{{else if (score>200) }}菜的像人{{else if (score>200) }}菜的像狗{{ else }}菜的像鸡{{/if}}
            </span>
        </p>
        <p>积分：<span id="score">{{ score || '0' }}</span></p>
    </div>
    <div id="questions">

        <div id="close"></div>
        <div id="question" data-id="" data-count=1>
            <div id="question-title">题目 1/15 </div>
            <div id="detail"></div>
            <div id="options">
                <label for="optionT">答案</label>
                <input name="option" type="radio" id="optionT" checked="checked" />T
                <label for="optionF"></label>
                <input name="option" type="radio" id="optionF" />F
            </div>
            <button id="viewAnswer">提交答案</button>
            <button id="viewNext">下一题</button>
        </div>
        <div id="answer"></div>
    </div>
    <script src="/libs/three.js"></script>
    <script src="/libs/socket.io.js"></script>
    <script src="/libs/Reflector.js"></script>
    <script src="/libs/GLTFLoader.js"></script>
    <script>
        const socket = io('192.168.1.103:3003');
        // const socket = io('3.87.214.11:3003');
    </script>
    <script src="/libs/FirstPersonControl.js"></script>
    <script src="/libs/RectAreaLightUniformsLib.js"></script>
    <script src="/libs/Tool.js"></script>
    <script src="/libs/OrbitControls.js"></script>
    <script src="/libs/Showcase.js"></script>
    <script src="/libs/container.js"></script>

    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="/libs/question.js"></script>
    <script>
        let fpc;
        let scene;
        let camera;
        let renderer;
        let showcase;
        let index = 0;
        let flylights; //浮动灯光
        let arrowHelper; //辅助箭头
        let playerMap = new Map(); //玩家id与模型对应
        let sceneMap = new Map(); //玩家id与场景对应
        let nameMap = new Map(); //玩家id与昵称对应
        let noRepeat = true; //禁止持续更换场景
        let animationId = 0; //每个场景均所使用的动画id记录量
        let arrowFloat = 0.05; //辅助箭头浮动幅度
        let house = new THREE.Object3D(); //博物馆主体
        let loader = new THREE.GLTFLoader();
        let scenes = ["", "", "", "", ""]; //五个场景
        const SCREEN_WIDTH = window.innerWidth,
            SCREEN_HEIGHT = window.innerHeight;
        socket.emit('login', {
            name: $("#getUserName").text()
        });

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xaaaaaa);
            scene.background = new THREE.CubeTextureLoader().setPath('resources/skybox/').load(
                [
                    'px.jpg',
                    'nx.jpg',
                    'py.jpg',
                    'ny.jpg',
                    'pz.jpg',
                    'nz.jpg'
                ]
            );
            let colors = [0xff0040, 0x80ff80, 0x00ffff, 0xcc3299, 0x236b8e, 0xffecae, 0x236b8e, 0x70db9e];
            flylights = ["", "", "", "", "", "", "", ""];
            for (let i = 0; i < 8; i++) {
                let position = getRandomPosition();
                flylights[i] = getBulb(position[0], position[1], position[2], 2, 6, 80, colors[i]);
            }
            setInterval(function() {
                for (let i = 0; i < 8; i++) {
                    let position = getRandomPosition();
                    flylights[i].position.set(position[0], position[1], position[2]);
                }
            }, 3000);
            const VIEW_ANGLE = 45,
                ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT,
                NEAR = 0.3,
                FAR = 5000;
            camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
            camera.lookAt(new THREE.Vector3(0, 15, 0));
            scene.add(camera);
            fpc = new FirstPersonControls(camera, scene);
            fpc.connect();
            scene.add(fpc.yawObject);
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });
            renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
            document.body.appendChild(renderer.domElement);
            showcase = new Showcase(renderer);
            showing = false;
            initMuseum();
            render();
            scenes[1] = new THREE.Object3D();
            initSecond();
        }
        let clock = new THREE.Clock();

        function render() {
            fpc.update(clock.getDelta());
            arrowHelper.position.y += arrowFloat;
            if (arrowHelper.position.y > 11)
                arrowFloat = -0.05;
            if (arrowHelper.position.y < 9)
                arrowFloat = 0.05;
            arrowHelper.visible = noRepeat;
            if (showing)
                renderer.render(showcase.scene, showcase.camera);
            else
                renderer.render(scene, camera);
            socket.emit('player', {
                position: fpc.yawObject.position,
                rotation: fpc.yawObject.rotation,
                index: index
            });
            requestAnimationFrame(render);
        }

        function makeHelper() {
            let dir = new THREE.Vector3(0, -10, 0);
            // 规格化方向向量(转换为长度为1的向量)
            dir.normalize();
            // 箭头开始的点
            let origin = new THREE.Vector3(0, 10, 0);
            // 箭头的长度。默认值为1
            let length = 1;
            // 用于定义颜色的十六进制值。默认值为0xffff00
            let hex = 0xffff00;
            // 箭头的长度。默认值为0.2 *length
            let headLength = 8;
            // 箭头宽度的长度。默认值为0.2 * headLength。
            let headWidth = 6;
            arrowHelper = new THREE.ArrowHelper(dir, origin, length, hex, headLength, headWidth);
            scene.add(arrowHelper);
        }

        function initMuseum() {
            makeHelper();
            //创建博物馆主体房子
            let wallTextTure = new THREE.TextureLoader().load('/resources/floor/wallfloor.jpg');
            let skyTextTure = new THREE.TextureLoader().load('/resources/floor/skyfloor.jpg');
            for (let i = 0; i < 20; i++) {
                let z = 75 + 200 * i;
                let left = getWall(30, 200, 600, -815, 270, z, wallTextTure);
                let right = getWall(30, 200, 600, 815, 270, z, wallTextTure);
                for (let j = 0; j < 4; j++) {
                    let top = getWall(405, 201, 10, -607.5 + 405 * j, 570, z, skyTextTure);
                    house.add(top);
                }
                house.add(left);
                house.add(right);
            }
            //添加墙体
            let leftTextTure = new THREE.TextureLoader().load('/resources/floor/boy.jpg');
            let rightTextTure = new THREE.TextureLoader().load('/resources/floor/sugar.jpg');
            let forwardLeft = getWall(800, 30, 600, -400, 270, 3990, leftTextTure);
            let forwardRight = getWall(800, 30, 600, 400, 270, 3990, rightTextTure);
            house.add(forwardLeft);
            house.add(forwardRight);
            //添加浮动灯光
            for (let i = 0; i < 8; i++) {
                house.add(flylights[i]);
            }
            scenes[0] = new THREE.Object3D();
            initFirst();
            scene.add(scenes[0]);
        }
        //博物馆外
        function initFirst() {
            let materialGrass = new THREE.MeshPhongMaterial({
                map: THREE.ImageUtils.loadTexture('/resources/floor/grass.jpg')
            });
            let mapPlane = new THREE.PlaneGeometry(9000, 9000, 4, 4);
            let meshPlane = new THREE.Mesh(mapPlane, materialGrass);
            meshPlane.position.set(0, -10, 0);
            meshPlane.rotation.set(-0.5 * Math.PI, 0, 0);
            scenes[0].add(meshPlane);
            const light = new THREE.AmbientLight(0xaaaaaa);
            scenes[0].add(light);
            let operationMaterial = new THREE.MeshPhongMaterial({
                map: THREE.ImageUtils.loadTexture('/resources/tips/operation.jpg')
            });
            let operationGeo = new THREE.CubeGeometry(175, 75, 175);
            let operationMesh = new THREE.Mesh(operationGeo, operationMaterial);
            operationMesh.position.set(-500, 37, 0);
            scenes[0].add(operationMesh);
            loader.load("/resources/museum/scene.gltf", function(mesh) {
                mesh.scene.scale.set(160, 160, 160);
                mesh.scene.position.set(0, 0, -800);
                scenes[0].add(mesh.scene);
            });
        }
        //容器厅 器
        function initSecond() {
            let backWard = getWall(1600, 30, 600, 0, 270, -40, getText("器"));
            scenes[1].add(backWard);
            let mirror = getMirror(1600, 4000, 0, 0, 1975);
            mirror.rotateX(-Math.PI / 2);
            scenes[1].add(mirror);
            //添加灯泡
            for (let i = 0; i < 20; i++) {
                let z = 75 + 200 * i;
                let leftBulb = getBulb(-800, 270, z, 8, 0.2, 2000, 0xffaa00);
                let rightBulb = getBulb(780, 270, z, 8, 0.2, 2000, 0xffaa00);
                scenes[1].add(leftBulb);
                scenes[1].add(rightBulb);
            }
            //添加玻璃盒
            for (let i = 0; i < 5; i++) {
                let z = 375 + i * 800;
                scenes[1].add(getGlass(400, 100, z, 200, 200, 200, 0.1, 0xffaa00));
                scenes[1].add(getGlass(-400, 100, z, 200, 200, 200, 0.1, 0xffaa00));
            }
            //添加容器
            getContainer(10, '/resources/container/bowl/scene.gltf', 400, 5, 375, 1);
            getContainer(0.5, '/resources/container/cup/scene.gltf', 400, 15, 1175, 2);
            getContainer(6, '/resources/container/jar/scene.gltf', 400, 20, 1975, 3);
            getContainer(40, '/resources/container/flagon/scene.gltf', 400, 50, 2775, 4);
            getContainer(5, '/resources/container/jug/scene.gltf', 400, 20, 3575, 5);
            getContainer(4, '/resources/container/kelin/scene.gltf', -400, 50, 375, 6);
            getContainer(40, '/resources/container/kettle/scene.gltf', -400, 50, 1175, 7);
            getContainer(5, '/resources/container/plate/scene.gltf', -400, 20, 1975, 8);
            getContainer(40, '/resources/container/pot/scene.gltf', -400, 40, 2775, 9);
            getContainer(1, '/resources/container/vase/scene.gltf', -400, 20, 3575, 10);
        }

        function getContainer(scale, path, x, y, z, name) {
            loader.load(path, function(mesh) {
                mesh.scene.scale.set(scale, scale, scale);
                mesh.scene.position.set(x, y, z);
                let object = new THREE.Object3D();
                object.name = name;
                object.add(mesh.scene);
                scenes[1].add(object);
                //照亮容器的聚光灯
                let spotLight = new THREE.SpotLight(0xffaa00, 25, 600, Math.PI / 4);
                spotLight.position.set(x, y + 400, z);
                spotLight.target = mesh.scene;
                scenes[1].add(spotLight);
            });
        }
        //名画厅 画
        function initThird() {
            let backWard = getWall(1600, 30, 600, 0, 270, -40, getText("画"));
            scenes[2].add(backWard);
            let mirror = getMirror(1600, 4000, 0, 0, 1975);
            mirror.rotateX(-Math.PI / 2);
            scenes[2].add(mirror);
            //third_scene
            let rotation = Math.PI / 2;
            //添加灯光
            let light1 = getLightBoard(0xd98719, 10, 3800, 40, -10, 245, 2075);
            let light2 = getLightBoard(0xd98719, 10, 3800, 40, 10, 245, 2075);
            light1.rotateY(Math.PI / 2);
            light1.rotateX(-Math.PI * 2 / 3);
            light2.rotateY(-Math.PI / 2);
            light2.rotateX(-Math.PI * 2 / 3);
            scenes[2].add(light1);
            scenes[2].add(light2);
            for (let i = 0; i < 5; i++) {
                let z = 480 + 760 * i;
                scenes[2].add(getBulb(-20, 230, z, 8, 3.2, 600, 0xd98719));
                scenes[2].add(getBulb(0, 235, z, 8, 3.2, 600, 0xd98719));
            }
            scenes[2].add(getBulb(400, 550, 2975, 40, 0.5, 4000, 0xd98719));
            scenes[2].add(getBulb(400, 550, 975, 40, 0.5, 4000, 0xd98719));
            scenes[2].add(getBulb(-400, 550, 2975, 40, 0.5, 4000, 0xd98719));
            scenes[2].add(getBulb(-400, 550, 975, 40, 0.5, 4000, 0xd98719));
            scenes[2].add(getWall(10, 3800, 250, 0, 125, 2075, null));
            //添加画作
            getPainting(3558, 220, '/resources/paintings/Qing.jpg', 6, 125, 2075, rotation, 11);
            getPainting(3787, 150, '/resources/paintings/Qian.jpg', -6, 125, 2075, -rotation, 12);
            getPainting(190, 150, '/resources/paintings/Athens.jpg', 797, 150, 375, -rotation, 1);
            getPainting(85, 70, '/resources/paintings/De.jpg', 797, 150, 1175, -rotation, 2);
            getPainting(95, 45, '/resources/paintings/Guernica.jpg', 797, 150, 1975, -rotation, 3);
            getPainting(60, 40, '/resources/paintings/Land.jpg', 797, 150, 2775, -rotation, 4);
            getPainting(145, 215, '/resources/paintings/Mona.jpg', 797, 150, 3575, -rotation, 5);
            getPainting(102, 68, '/resources/paintings/Gleaners.jpg', -797, 150, 375, rotation, 6);
            getPainting(80, 50, '/resources/paintings/Adma.jpg', -797, 150, 1175, rotation, 7);
            getPainting(95, 55, '/resources/paintings/Supper.jpg', -797, 150, 1975, rotation, 8);
            getPainting(95, 75, '/resources/paintings/Night.jpg', -797, 150, 2775, rotation, 9);
            getPainting(75, 55, '/resources/paintings/Sunday.jpg', -797, 150, 3575, rotation, 10);
        }

        function getPainting(width, height, path, x, y, z, rotationY, name) {
            let materialPicture = new THREE.MeshPhongMaterial({
                map: new THREE.TextureLoader().load(path)
            });
            let picturePlane = new THREE.PlaneGeometry(width, height, 4, 4);
            let meshPicture = new THREE.Mesh(picturePlane, materialPicture);
            meshPicture.position.set(x, y, z);
            meshPicture.receiveShadow = true;
            meshPicture.rotation.set(Math.PI, rotationY, 0);
            let object = new THREE.Object3D();
            object.name = name;
            object.add(meshPicture);
            scenes[2].add(object);
        }
        //兵器厅 兵
        function initForth() {
            let backWard = getWall(1600, 30, 600, 0, 270, -40, getText("兵"));
            scenes[3].add(backWard);
            let mirror = getMirror(1600, 4000, 0, 0, 1975);
            mirror.rotateX(-Math.PI / 2);
            scenes[3].add(mirror);
            //forth_scene
            scenes[3].add(getBulb(0, 550, 2975, 50, 0.8, 4000, 0x4f4f2f));
            scenes[3].add(getBulb(0, 550, 975, 50, 0.8, 4000, 0x4f4f2f));
            scenes[3].add(new THREE.AmbientLight(0x4f4f2f, 1));
            //添加玻璃盒
            for (let i = 0; i < 5; i++) {
                let z = 375 + i * 800;
                scenes[3].add(getGlass(400, 100, z, 200, 200, 200, 0.2, 0x4f4f2f));
                scenes[3].add(getGlass(-400, 100, z, 200, 200, 200, 0.2, 0x4f4f2f));
            }
            getWeapon(32, '/resources/weapon/axe/scene.gltf', 400, 70, 375, 1);
            getWeapon(0.05, '/resources/weapon/boomerang/scene.gltf', 400, 70, 1175, 2);
            getWeapon(1, '/resources/weapon/shield/scene.gltf', 450, 70, 1975, 200, 3);
            getWeapon(3, '/resources/weapon/crossbow/scene.gltf', 400, 30, 2775, 4);
            getWeapon(12, '/resources/weapon/halberd/scene.gltf', 400, 80, 3575, 5);
            getWeapon(20, '/resources/weapon/knife/scene.gltf', -400, 70, 375, 6);
            getWeapon(12, '/resources/weapon/lance/scene.gltf', -400, 50, 1175, 7);
            getWeapon(40, '/resources/weapon/spear/scene.gltf', -400, 50, 1975, 8);
            getWeapon(0.8, '/resources/weapon/stick/scene.gltf', -420, 50, 2655, 9);
            getWeapon(12, '/resources/weapon/sword/scene.gltf', -400, 70, 3575, 10);
        }

        function getWeapon(scale, path, x, y, z, name) {
            loader.load(path, function(mesh) {
                mesh.scene.scale.set(scale, scale, scale);
                mesh.scene.position.set(x, y, z);
                let object = new THREE.Object3D();
                object.name = name;
                object.add(mesh.scene);
                scenes[3].add(object);
            });
        }
        //饰品厅 饰
        function initFifth() {
            let backWard = getWall(1600, 30, 600, 0, 270, -40, getText("饰"));
            scenes[4].add(backWard);
            let mirror = getMirror(1600, 4000, 0, 0, 1975);
            mirror.rotateX(-Math.PI / 2);
            scenes[4].add(mirror);
            //fifth_scene
            const light = new THREE.AmbientLight(0xdddddd, 0.2);
            scenes[4].add(light);
            //添加灯光
            for (let i = 0; i < 5; i++) {
                let z = 375 + 800 * i;
                let lightLeft = getLightBoard(0xdddddd, 40, 20, 20, 400, 20, z);
                let lightRight = getLightBoard(0xdddddd, 40, 20, 20, -400, 20, z);
                lightLeft.rotateX(Math.PI / 2);
                lightRight.rotateX(Math.PI / 2);
                scenes[4].add(lightLeft);
                scenes[4].add(lightRight);
                scenes[4].add((getWall(20, 20, 20, 400, 9.5, z)));
                scenes[4].add((getWall(20, 20, 20, -400, 9.5, z)));
                scenes[4].add((getBulb(390, 50, z, 8, 0.4, 100, 0xdddddd)));
                scenes[4].add((getBulb(-410, 50, z, 8, 0.4, 100, 0xdddddd)));
                scenes[4].add(getLine(-400, 51, z, 0xdddddd, -400, 590, z));
                scenes[4].add(getLine(400, 51, z, 0xdddddd, 400, 590, z));
            }
            //添加饰品
            getTreasure(0.05, '/resources/treasure/ankh/scene.gltf', 400, 20, 375, 1);
            getTreasure(4, '/resources/treasure/bracelet/scene.gltf', 400, 24, 1175, 2);
            getTreasure(80, '/resources/treasure/eardrop/scene.gltf', 400, 18, 1975, 3);
            getTreasure(0.5, '/resources/treasure/green/scene.gltf', 380, 25, 2790, 4);
            getTreasure(12, '/resources/treasure/jade/scene.gltf', 400, 23, 3575, 5);
            getTreasure(50, '/resources/treasure/necklace/scene.gltf', -400, -55, 375, 6);
            getTreasure(50, '/resources/treasure/rabbit/scene.gltf', -400, 20, 1175, 7);
            getTreasure(2, '/resources/treasure/red/scene.gltf', -400, 25, 1975, 8);
            getTreasure(0.12, '/resources/treasure/ring/scene.gltf', -400, 23, 2775, 9);
            getTreasure(0.02, '/resources/treasure/white/scene.gltf', -400, 29, 3575, 10);
        }

        function getTreasure(scale, path, x, y, z, name) {
            loader.load(path, function(mesh) {
                mesh.scene.scale.set(scale, scale, scale);
                mesh.scene.position.set(x, y, z);
                let object = new THREE.Object3D();
                object.name = name;
                object.add(mesh.scene);
                scenes[4].add(object);
            });
        }
        //回退
        function back() {
            cancelAnimationFrame(animationId);
            if (index === 0)
                return;
            clearModel();
            scene.remove(scenes[index]);
            index--;
            //判断前一场景是否初始化
            if (scenes[index] === null) {
                switch (index) {
                    case 0:
                        scenes[0] = new THREE.Object3D();
                        initFirst();
                        //离开博物馆，移除房子
                        scene.remove(house);
                        break;
                    case 1:
                        scenes[1] = new THREE.Object3D();
                        initSecond();
                        break;
                    case 2:
                        scenes[1] = new THREE.Object3D();
                        initThird();
                        break;
                    case 3:
                        scenes[2] = new THREE.Object3D();
                        initForth();
                        break;
                }
            }
            //更换场景，初始化下一场景
            scene.add(scenes[index]);
            changeRole(index + 1, index);
            switch (index) {
                case 0:
                    scenes[1] = new THREE.Object3D();
                    initSecond();
                    //离开博物馆，移除房子
                    scene.remove(house);
                    break;
                case 1:
                    scenes[0] = new THREE.Object3D();
                    initFirst();
                    break;
                case 2:
                    scenes[1] = new THREE.Object3D();
                    initSecond();
                    break;
                case 3:
                    scenes[2] = new THREE.Object3D();
                    initThird();
                    break;
            }
        }

        function forward() {
            cancelAnimationFrame(animationId);
            if (index === 4)
                return;
            clearModel();
            scene.remove(scenes[index]);
            index++;
            //更换场景，初始化下一场景
            scene.add(scenes[index]);
            changeRole(index - 1, index);
            switch (index) {
                case 1:
                    scenes[2] = new THREE.Object3D();
                    initThird();
                    //进入博物馆，添加房子
                    scene.add(house);
                    break;
                case 2:
                    scenes[3] = new THREE.Object3D();
                    initForth();
                    break;
                case 3:
                    scenes[4] = new THREE.Object3D();
                    initFifth();
                    break;
                case 4:
                    scenes[3] = new THREE.Object3D();
                    initForth();
                    break;
            }
        }
        //清理不用的场景
        function clearModel() {
            // 判断类型
            if (scenes[index] instanceof THREE.Scene) {
                let children = scenes[index].children;
                for (let i = 0; i < children.length; i++) {
                    deleteGroup(children[i]);
                }
            } else {
                deleteGroup(scenes[index]);
            }
            scenes[index] = null;
            scene.remove(scenes[index]);
        }

        function changeRole(oldIndex, newIndex) {
            for (let id of playerMap) {
                if (sceneMap.get(id[0]) === oldIndex) {
                    scene.remove(playerMap.get(id[0]));
                }
                if (sceneMap.get(id) === newIndex)
                    scene.add(playerMap.get(id[0]));
            }
        }

        function getModel() {
            let length = scenes[index].children.length;
            let findName = getName();
            for (let i = 0; i < length; i++) {
                if (!scenes[index].children[i].hasOwnProperty("name"))
                    continue;
                let name = scenes[index].children[i].name;
                if (name === findName)
                    return scenes[index].children[i];
            }
        }

        function getName() {
            let x = fpc.yawObject.position.x;
            let add = x > 0 ? 0 : 5;
            let base = parseInt((fpc.yawObject.position.z + 25) / 800) + 1 + add;
            if (index === 2 && Math.abs(x) < 400)
                base = x > 0 ? 11 : 12;
            return base;
        }
        //用户数据和响应
        socket.on('player', data => {
            if (playerMap.has(data.socketid)) {
                let model = playerMap.get(data.socketid);
                if (model === null) {
                    return;
                }
                model.position.set(data.position.x, data.position.y + 30, data.position.z);
                model.rotation.set(data.rotation._x, data.rotation._y + Math.PI, data.rotation._z);
                if (data.index !== sceneMap.get(data.socketid)) {
                    if (sceneMap.get(data.socketid) === index)
                        scene.remove(playerMap.get(data.socketid));
                    sceneMap.set(data.socketid, data.index);
                    if (data.index === index)
                        scene.add(playerMap.get(data.socketid));
                }
            } else {
                playerMap.set(data.socketid, null);
                loader.load("/resources/role/scene.gltf", (mesh) => {
                    mesh.scene.scale.set(30, 30, 30);
                    mesh.scene.name = "person";
                    playerMap.set(data.socketid, mesh.scene);
                    sceneMap.set(data.socketid, data.index);
                    if (data.index === index) {
                        scene.add(playerMap.get(data.socketid));
                    }
                });
            }
        });

        socket.on('offline', data => {
            if (sceneMap.get(data.socketid) === index)
                scene.remove(playerMap.get(data.socketid));
            playerMap.delete(data.socketid);
            sceneMap.delete(data.socketid);
            nameMap.delete(data.socketid);
            let userList = document.getElementById("userList");
            let option = document.getElementById(data.socketid);
            userList.removeChild(option);
        });
        //xwl 多人聊天
        socket.on('chatMany', data => {
            let chatP = document.createElement("p");
            chatP.style.maxWidth = "250px";
            chatP.innerHTML = data.name + ":" + (data.message || "");
            chatLog.appendChild(chatP);
            if (chatLog.children.length > 2) {
                chatLog.lastChild.scrollIntoView();
            }
        });
        socket.on('chatOne', data => {
            let chatP = document.createElement("p");
            chatP.style.maxWidth = "250px";
            chatP.innerHTML = data.from + " ：" + (data.message || "");
            chatLog.appendChild(chatP);
            if (chatLog.children.length > 2) {
                chatLog.lastChild.scrollIntoView();
            }
        });
        socket.on('login', data => {
            console.log(data);
            data.userMap.map(t => {
                $("#userList").append("<option id = '" + t.socketid + "'>" + t.name + "</option>");
            });
        });
        window.addEventListener("resize", function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        const KEY_B = 66;
        const KEY_N = 78;
        const KEY_O = 79;
        document.addEventListener("keydown", function(e) {
            if (fpc.canChat)
                return;
            let distance = Math.sqrt(Math.pow(fpc.yawObject.position.x, 2) + Math.pow(fpc.yawObject.position.z, 2));
            if (distance > 25) {
                noRepeat = true;
            }
            switch (e.keyCode) {
                case KEY_B:
                    if (distance < 25 && noRepeat) {
                        console.log('enter');
                        noRepeat = false;
                        back();
                    }
                    break;
                case KEY_N:
                    if (distance < 25 && noRepeat) {
                        noRepeat = false;
                        forward();
                    }
                    break;
                case KEY_O:
                    if (index === 0)
                        return;
                    showing = !showing;
                    if (showing) {
                        scene.remove(scenes[index]);
                        showcase.show(getModel(), index - 1);
                        fpc.removeLock();
                        document.exitPointerLock();
                    } else {
                        let model = showcase.delete();
                        scenes[index].add(model);
                        scene.add(scenes[index]);
                        fpc.addLock();
                        fpc.domElement.requestPointerLock();
                    }
                    break;
            }
        });
        init();
    </script>
</body>

</html>